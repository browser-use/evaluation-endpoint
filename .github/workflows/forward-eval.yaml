name: Forward Evaluation to Private Repo

on:
  repository_dispatch:
    types: [run-eval]
  workflow_dispatch:

jobs:
  forward_evaluation:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Authenticate and forward dispatch to private repo
        run: |
          echo "=== FORWARDING EVALUATION DISPATCH ==="
          echo "Event type: ${{ github.event.action }}"
          echo "Repository: ${{ github.repository }}"
          echo "Forwarding to: evaluations-internal"
          echo "====================================="
          
          # Extract client payload
          CLIENT_PAYLOAD='${{ toJson(github.event.client_payload) }}'
          
          echo "Client payload received (security check in progress...):"
          
          # Security Check: Verify the secret key
          RECEIVED_SECRET=$(echo "$CLIENT_PAYLOAD" | jq -r '.secret_key // empty')
          EXPECTED_SECRET="${{ secrets.EVALUATION_ENDPOINT_SECRET }}"
          
          if [ -z "$RECEIVED_SECRET" ]; then
            echo "❌ SECURITY: No secret key provided in client payload"
            echo "❌ AUTHORIZATION FAILED: Request rejected"
            exit 1
          fi
          
          if [ "$RECEIVED_SECRET" != "$EXPECTED_SECRET" ]; then
            echo "❌ SECURITY: Invalid secret key provided"
            echo "❌ AUTHORIZATION FAILED: Request rejected"
            exit 1
          fi
          
          echo "✅ SECURITY: Secret key verified successfully"
          
          # Remove the secret key from payload before forwarding (security best practice)
          CLEAN_PAYLOAD=$(echo "$CLIENT_PAYLOAD" | jq 'del(.secret_key)')
          
          echo "Cleaned payload (secret removed):"
          echo "$CLEAN_PAYLOAD" | jq '.' || echo "Failed to parse cleaned payload as JSON"
          
          # Forward the dispatch to the private evaluations-internal repo
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.PRIVATE_REPO_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Content-Type: application/json" \
            -H "User-Agent: evaluation-endpoint-forwarder/1.0" \
            https://api.github.com/repos/${{ vars.PRIVATE_REPO_OWNER || 'your-org' }}/evaluations-internal/dispatches \
            -d "{
              \"event_type\": \"run-eval\",
              \"client_payload\": $CLEAN_PAYLOAD
            }" \
            --max-time 30 \
            --retry 3 \
            --fail-with-body || {
              echo "❌ Failed to forward dispatch to private repo"
              echo "Check that PRIVATE_REPO_TOKEN has access to the private repository"
              exit 1
            }
          
          echo "✅ Successfully forwarded evaluation dispatch to private repository"
          echo "The evaluation should now be running in evaluations-internal"

      - name: Log forwarding details
        if: always()
        run: |
          echo "=== FORWARDING SUMMARY ==="
          echo "Source: ${{ github.repository }}"
          echo "Target: evaluations-internal"
          echo "Event action: ${{ github.event.action }}"
          echo "Dispatch time: $(date -u)"
          echo "Run ID: ${{ github.run_id }}"
          echo "==========================" 